{% extends 'base.html' %}
{% load static %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/findID.css' %}">
<link rel="stylesheet" href="{% static 'css/findPW.css' %}">
{% endblock %}
{% block title %}비밀번호 찾기 - 할래말래{% endblock %}

{% block contents %}

<div class="findID-container">
    <div class="findID-wrapper">

        <!-- PC 브랜딩 -->
        <div class="findID-brand">
            <h2>할래말래</h2>
            <p>스포츠 시설을 쉽고 빠르게 예약하세요</p>
            <ul class="findID-brand-features">
                <li>간편한 온라인 예약</li>
                <li>다양한 스포츠 시설</li>
                <li>실시간 예약 현황</li>
                <li>안전한 결제 시스템</li>
            </ul>
        </div>

        <!-- PW 찾기 카드 -->
        <div class="findID-card">

            <div class="findID-header">
                <h1>비밀번호 찾기</h1>
                <p>등록된 정보로 본인확인을 진행합니다</p>
            </div>

            <form class="findID-form" method="post">
                {% csrf_token %}

                <!-- 아이디 -->
                <div class="form-group">
                    <label class="form-label">아이디</label>
                    <input type="text" name="user_id" class="form-input" placeholder="아이디 입력" required>
                </div>

                <!-- 이름 -->
                <div class="form-group">
                    <label class="form-label">이름</label>
                    <input type="text" name="name" class="form-input" placeholder="이름 입력" required>
                </div>

                <!-- 생년월일 -->
                <div class="form-group">
                    <label class="form-label">생년월일</label>
                    <input type="text" name="birthday" class="form-input" placeholder="예) 20020528 또는 2002-05-28" required>
                </div>

                <!-- 전화번호 -->
                <div class="form-group">
                    <label class="form-label">전화번호</label>
                    <div class="form-row phone-row">
                        <input type="text" name="phone1" class="form-input phone1" maxlength="3" value="010" required>
                        <span class="phone-dash">-</span>
                        <input type="text" name="phone2" class="form-input phone2" maxlength="4" placeholder="0000" required>
                        <span class="phone-dash">-</span>
                        <input type="text" name="phone3" class="form-input phone3" maxlength="4" placeholder="0000" required>
                    </div>
                </div>

                <button type="submit" class="findID-btn">비밀번호 찾기</button>
            </form>

            <div class="findID-links">
                <a href="/findID" class="form-link">ID 찾기</a>
                <span class="form-link-divider"></span>
                <a href="/login" class="form-link">로그인</a>
                <span class="form-link-divider"></span>
                <a href="/signup" class="form-link">회원가입</a>
            </div>

        </div>
    </div>
</div>

<div id="findPW-data" 
     {% if error %}data-error="{{ error|escapejs }}"{% endif %}
     {% if result_pw %}data-result-pw="{{ result_pw|escapejs }}"{% endif %}
     style="display: none;"></div>

{% if result_pw %}
<!-- 임시 비밀번호 모달 -->
<div id="pwModal" class="pw-modal" aria-hidden="false">
  <div class="pw-modal-backdrop"></div>
  <div class="pw-modal-content" role="dialog" aria-modal="true" aria-labelledby="pwModalTitle">
    <h2 id="pwModalTitle">임시 비밀번호 안내</h2>
    <p>아래 임시 비밀번호로 로그인한 뒤, 마이페이지에서 반드시 비밀번호를 변경해주세요.</p>
    <div class="pw-modal-inline">
      <input type="text" id="pwModalInput" class="form-input" value="{{ result_pw }}" readonly>
      <button type="button" id="pwModalCopyBtn" class="findID-btn">복사</button>
    </div>
    <div class="pw-modal-actions">
      <button type="button" id="pwModalLoginBtn" class="findID-btn">로그인 페이지로 이동</button>
      <button type="button" id="pwModalCloseBtn" class="findPW-btn secondary">닫기</button>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block script1 %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 오류 메시지 alert
    var dataEl = document.getElementById('findPW-data');
    if (dataEl) {
        var errorMsg = dataEl.getAttribute('data-error');
        if (errorMsg) {
            alert(errorMsg);
        }
    }

    // 모달 관련 요소
    var modal = document.getElementById('pwModal');
    var input = document.getElementById('pwModalInput');
    var copyBtn = document.getElementById('pwModalCopyBtn');
    var closeBtn = document.getElementById('pwModalCloseBtn');
    var loginBtn = document.getElementById('pwModalLoginBtn');

    if (modal && input) {
        // 포커스 & 전체 선택
        setTimeout(function() {
            input.focus();
            input.select();
        }, 50);

        // 복사 버튼
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(input.value)
                        .then(function() {
                            alert('임시 비밀번호가 복사되었습니다. 로그인 후 비밀번호를 변경해주세요.');
                        })
                        .catch(function() {
                            input.select();
                            document.execCommand('copy');
                            alert('임시 비밀번호를 복사했습니다. (복사가 안되면 Ctrl+C를 사용해주세요)');
                        });
                } else {
                    input.select();
                    document.execCommand('copy');
                    alert('임시 비밀번호를 복사했습니다. 로그인 후 비밀번호를 변경해주세요.');
                }
            });
        }

        // 로그인 페이지로 이동
        if (loginBtn) {
            loginBtn.addEventListener('click', function() {
                window.location.href = "/login";
            });
        }

        // 닫기 버튼
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }

        // ESC로 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display !== 'none') {
                modal.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}
