{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/facility_list.css' %}" />
{% endblock %}

{% block script1 %}
<!-- ì¹´ì¹´ì˜¤ ì§€ë„ JS -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_SCRIPT_KEY }}"></script>
<script src="{% static 'js/facility_list.js' %}"></script>
{% autoescape off %}
<script>
    var facilities = {{ page_facilities|safe }};
    console.log("ì§€ë„ìš© ì‹œì„¤ ë°ì´í„°:", facilities);
</script>
{% endautoescape %}
{% endblock %}

{% block title %}
ì‹œì„¤ ëª©ë¡ - í• ë˜ë§ë˜
{% endblock %}

{% block contents %}

<div class="page-title-section">
    <h2 class="page-title">ì‹œì„¤ ëª©ë¡</h2>
</div>

<div class="sub-container">
    <div class="sub-content">

        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <section class="search-section">
            <div class="search-controls">
                <select id="sido" class="search-dropdown">
                    <option value="">ì‹œ/ë„ ì„ íƒ</option>
                </select>

                <select id="sigungu" class="search-dropdown">
                    <option value="">êµ¬/êµ° ì„ íƒ</option>
                </select>
            </div>

            <div class="search-input-group">
                <input type="text" class="search-input" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <button type="button" class="search-btn" id="searchBtn">
                    <span>ğŸ”</span> ê²€ìƒ‰
                </button>
            </div>
        </section>

        <!-- ì§€ë„ -->
        <section class="map">
            <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
        </section>

        <!-- ë¦¬ìŠ¤íŠ¸ -->
        <section class="search-list-section">
            ì´ {{ merged_count }} ê°œ
            <hr class="dividing-line">

            <div class="facility-list">
                <ul>
                    {% for item in page_obj %}
                    <li class="facility-item">
                        <span class="facility-order">{{ forloop.counter }}</span>

                        <span class="facility-title">
                            <!-- í´ë¦­ ì´ë²¤íŠ¸ìš© data-id ì¶”ê°€ -->
                            <a href="javascript:void(0);" 
                               class="facility-link"
                               data-id="{{ item.id }}">
                               {{ item.name }}
                            </a>
                        </span>

                        <span class="facility-meta">{{ item.phone }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </section>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination">
            {% if block_start > 1 %}
            <a href="?page={{ block_start|add:-1 }}&per_page={{ per_page }}" class="page-btn arrow">â—€ ì´ì „</a>
            {% else %}
            <span class="page-btn arrow disabled">â—€ ì´ì „</span>
            {% endif %}

            {% for num in block_range %}
                {% if num == page_obj.number %}
                <span class="page-btn active">{{ num }}</span>
                {% else %}
                <a href="?page={{ num }}&per_page={{ per_page }}" class="page-btn">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if block_end < paginator.num_pages %}
            <a href="?page={{ block_end|add:1 }}&per_page={{ per_page }}" class="page-btn arrow">ë‹¤ìŒ â–¶</a>
            {% else %}
            <span class="page-btn arrow disabled">ë‹¤ìŒ â–¶</span>
            {% endif %}
        </div>

    </div>
</div>

{% endblock %}

{% block script3 %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    var container = document.getElementById("map");
    var map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 7
    });

    var bounds = new kakao.maps.LatLngBounds();
    var markerMap = {};  

    facilities.forEach(function (item) {
        var lat = parseFloat(item.lat);
        var lng = parseFloat(item.lng);

        if (isNaN(lat) || isNaN(lng)) return;

        var pos = new kakao.maps.LatLng(lat, lng);

        var marker = new kakao.maps.Marker({
            map: map,
            position: pos
        });

        var infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:14px;"><a href='/facility/detail/${item.id}'>${item.name}</a></div>`
        });

        kakao.maps.event.addListener(marker, "mouseover", function () {
            infowindow.open(map, marker);
        });
        kakao.maps.event.addListener(marker, "mouseout", function () {
            infowindow.close();
        });

        // kakao.maps.event.addListener(marker, "click", function () {
        //     window.location.href = "/facility/detail/" + item.id;
        // });

        markerMap[item.id] = { 
            marker: marker,
            infowindow: infowindow,
            position: pos
        };

        bounds.extend(pos);
    });

    if (!bounds.isEmpty()) {
        map.setBounds(bounds);
    }

    // â­ ë¦¬ìŠ¤íŠ¸ í´ë¦­ â†’ ì§€ë„ í¬ì»¤ìŠ¤ ì´ë™
    document.querySelectorAll(".facility-link").forEach(function(link) {
        link.addEventListener("click", function() {
            var id = this.dataset.id;
            var obj = markerMap[id];

            if (!obj) {
                alert("í•´ë‹¹ ì‹œì„¤ì˜ ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            map.setCenter(obj.position);
            map.setLevel(5);
            obj.infowindow.open(map, obj.marker);

            // â­ ì—¬ê¸°ë§Œ ë³€ê²½ë¨ â€” ì§€ë„ í™”ë©´ ì •ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤
            const mapRect = document.getElementById("map").getBoundingClientRect();
            window.scrollTo({
                top: window.pageYOffset + mapRect.top - 100, // ì§€ë„ ìœ„ë¡œ 100px ì •ë„ ì—¬ìœ 
                behavior: "smooth"
            });
        });
    });

});
</script>
{% endblock %}
