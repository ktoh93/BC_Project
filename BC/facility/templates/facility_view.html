{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/facility_list.css' %}" />
<link rel="stylesheet" href="{% static 'css/facility_detail.css' %}" />
{% endblock %}

{% block script1 %}
<!-- 카카오 지도 JS -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_SCRIPT_KEY }}"></script>

{% autoescape off %}
<script>
    var facility = {{ facility| safe }};
    console.log("상세페이지 시설 데이터:", facility);
</script>
{% endautoescape %}
{% endblock %}

{% block title %}
시설 상세보기 - 할래말래
{% endblock %}

{% block contents %}

<!-- Hero 섹션 -->
<div class="board-hero facility-hero">
    <h2>시설안내</h2>
</div>

<div class="sub-container">
    <div class="sub-content">
        <section class="detail-top-wrapper">

            <!-- 왼쪽 80% 이미지 -->
            <section class="detail-image-wrap">
                {% if facility.image_url %}
                <img src="{{ facility.image_url }}" alt="{{ facility.name }}">
                {% else %}
                <img src="{% static 'img/no_image.png' %}" alt="사진 없음">
                {% endif %}
            </section>

            <!-- 오른쪽 20% 정보 -->
            <section class="detail-info-wrap">
                <h3>{{ facility.name }}</h3>

                <p>
                <section class="detail-info-row">
                    <b>업종명 :</b> <span>{{ facility.fcob_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>주소 :</b> <span>{{ facility.address }}</span>
                </section>

                {% if facility.phone %}
                <section class="detail-info-row">
                    <b>전화번호 :</b> <span>{{ facility.phone }}</span>
                </section>
                {% endif %}

                <section class="detail-info-row">
                    <b>운영상태 :</b> <span>{{ facility.faci_stat_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>안전등급 :</b> <span>{{ facility.schk_tot_grd_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>예약가능 :</b>
                    <span>
                        {% if can_reserve %}
                        가능
                        {% else %}
                        해당 시설에 문의해주세요
                        {% endif %}
                    </span>
                </section>
                </p>

                <section class="detail-buttons">
                    {% if can_reserve %}
                    <a href="/reservation/reserve/{{ facility.id }}">예약하기</a>
                    {% endif %}
                    <a href="/recruitment/{{ facility.id }}">모집글가기</a>
                    
                    <a href="javascript:history.back();" class="back-btn">
                        리스트로 돌아가기
                    </a>
                </section>
            </section>

        </section>
        <!-- 지도 -->
        <section class="map">
            <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
        </section>


    </div>

    <hr>

    <!-- 댓글 섹션 -->
    <section class="comment-section">
        <h3 class="section-title">댓글</h3>

        <!-- 댓글 리스트 -->
        <ul class="comment-list">
            {% for c in comments %}
            <li class="comment-item">
                <div class="comment-meta">
                    <span class="comment-writer">{{ c.writer_name }}</span>
                    <span class="comment-date">{{ c.created_at|date:"Y-m-d H:i" }}</span>
                </div>
                <p class="comment-content">{{ c.content|linebreaksbr }}</p>
            </li>
            {% empty %}
            <li class="comment-empty">아직 등록된 댓글이 없습니다.</li>
            {% endfor %}
        </ul>

        <!-- 댓글 입력 폼 -->
        <form method="post" class="comment-form">
            {% csrf_token %}
            <label for="comment" class="form-label">댓글 쓰기</label>
            <textarea id="comment" name="content" class="form-textarea" rows="3" required></textarea>

            <div class="comment-btn-box">
                <button type="submit" class="btn-primary">등록</button>
            </div>
        </form>
    </section>
</div>

{% endblock %}

{% block script3 %}
<script>
    document.addEventListener("DOMContentLoaded", function () {

        var container = document.getElementById("map");
        var map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7,
            draggable: false,                    // 드래그 금지
            scrollwheel: false,                  // 휠 확대/축소 금지
            disableDoubleClickZoom: true,        // 더블클릭 확대 금지
            keyboardShortcuts: false             // 키보드 이동 금지
        });


        var lat = parseFloat(facility.lat);
        var lng = parseFloat(facility.lng);

        // 좌표가 있는 경우만 지도 이동
        if (!isNaN(lat) && !isNaN(lng)) {
            var pos = new kakao.maps.LatLng(lat, lng);

            var marker = new kakao.maps.Marker({
                map: map,
                position: pos
            });

            // 인포윈도우
            var infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:14px;">${facility.name}</div>`
            });

            infowindow.open(map, marker);

            map.setCenter(pos);
            map.setLevel(2);
        } else {
            console.warn("좌표 없음 → 기본 지도 위치로 표시됨.");
        }

    });
</script>
{% endblock %}