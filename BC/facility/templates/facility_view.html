{% extends 'base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/facility_list.css' %}" />
<link rel="stylesheet" href="{% static 'css/facility_detail.css' %}" />
{% endblock %}

{% block script1 %}
<!-- ì¹´ì¹´ì˜¤ ì§€ë„ JS -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_SCRIPT_KEY }}"></script>

{% autoescape off %}
<script>
    var facility = {{ facility| safe }};

</script>
{% endautoescape %}
{% endblock %}

{% block title %}
ì‹œì„¤ ìƒì„¸ë³´ê¸° - í• ë˜ë§ë˜
{% endblock %}

{% block contents %}

<!-- Hero ì„¹ì…˜ -->
<div class="board-hero facility-hero">
    <h2>ì‹œì„¤ì•ˆë‚´</h2>
</div>

<div class="sub-container">
    <div class="sub-content">
        <section class="detail-top-wrapper">

            <!-- ì™¼ìª½ 80% ì´ë¯¸ì§€ -->
            <section class="detail-image-wrap">
                {% if facility.image_url %}
                <img src="{{ facility.image_url }}" alt="{{ facility.name }}">
                {% else %}
                <img src="{% static 'img/no_image.png' %}" alt="ì‚¬ì§„ ì—†ìŒ">
                {% endif %}
            </section>

            <!-- ì˜¤ë¥¸ìª½ 20% ì •ë³´ -->
            <section class="detail-info-wrap">
                <h3>{{ facility.name }}</h3>

                <p>
                {% if facility.files %}
                <section class="detail-info-row">
                    <b>ì²¨ë¶€íŒŒì¼</b>
                    <ul class="files-list">
                        {% for file in facility.files %}
                        <li class="file-item">
                            <a href="{{ file.url }}" download class="file-link">
                                <span class="file-name">{{ file.name }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </section>
                {% endif %}
                <section class="detail-info-row">
                    <b>ì—…ì¢…ëª… :</b> <span>{{ facility.fcob_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì£¼ì†Œ :</b> <span>{{ facility.address }}</span>
                </section>

                {% if facility.phone %}
                <section class="detail-info-row">
                    <b>ì „í™”ë²ˆí˜¸ :</b> <span>{{ facility.phone }}</span>
                </section>
                {% endif %}

                <section class="detail-info-row">
                    <b>ìš´ì˜ìƒíƒœ :</b> <span>{{ facility.faci_stat_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì•ˆì „ë“±ê¸‰ :</b> <span>{{ facility.schk_tot_grd_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì˜ˆì•½ê°€ëŠ¥ :</b>
                    <span>
                        {% if can_reserve %}
                        ê°€ëŠ¥
                        {% else %}
                        í•´ë‹¹ ì‹œì„¤ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”
                        {% endif %}
                    </span>
                </section>
                </p>

                <section class="detail-buttons">
                    {% if can_reserve %}
                    <a href="/reservation/{{ facility.id }}" class="btn-reserve" data-facility-id="{{ facility.id }}">
                        ì˜ˆì•½í•˜ê¸°
                    </a>
                    {% endif %}

                    {% if can_recruit %}
                    <a href="/recruitment/?search_type=facility&keyword={{ facility.name }}" class="btn-recruit">
                        ëª¨ì§‘ê¸€ê°€ê¸°
                    </a>
                    {% endif %}

                    <a href="javascript:history.back();" class="back-btn">
                        ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°
                    </a>

                </section>
            </section>

        </section>
        <!-- ì§€ë„ -->
        <section class="map">
            <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
        </section>


    </div>

    <hr>

    <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
    <section class="comment-section">
        <h3 class="section-title">ëŒ“ê¸€ ({{ comments|length }})</h3>

        <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
        <ul class="comment-list">
            {% for comment in comments %}
            <li class="comment-item {% if comment.is_deleted %}comment-deleted{% endif %}">
                <div class="comment-meta">
                    <span class="comment-writer {% if comment.is_admin %}admin-badge{% endif %}">
                        {{ comment.author }}{% if comment.is_admin %} ğŸ‘‘{% endif %}
                    </span>
                    <span class="comment-date">
                        {{ comment.reg_date|date:"Y-m-d H:i" }}
                    </span>

                    {% if is_manager and not comment.is_deleted %}
                    <button type="button" class="comment-delete-btn" data-comment-id="{{ comment.comment_id }}">
                        ì‚­ì œ
                    </button>
                    {% endif %}
                </div>

                <p class="comment-content">{{ comment.comment|linebreaksbr }}</p>
            </li>
            {% empty %}
            <li class="comment-empty">ì•„ì§ ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
        </ul>

        <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
        <form method="post" action="{% url 'facility_comment' facility.id %}" class="comment-form">
            {% csrf_token %}
            <label for="comment" class="form-label">ëŒ“ê¸€ ì“°ê¸°</label>
            <textarea id="comment" name="content" class="form-textarea" rows="3" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
                required></textarea>
            <div class="comment-btn-box">
                <button type="submit" class="btn btn-submit">ë“±ë¡</button>
            </div>
        </form>
    </section>
</div>

{% endblock %}

{% block script3 %}
<script>
    document.addEventListener("DOMContentLoaded", function () {

        var container = document.getElementById("map");
        var map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 7,
            draggable: false,                    // ë“œë˜ê·¸ ê¸ˆì§€
            scrollwheel: false,                  // íœ  í™•ëŒ€/ì¶•ì†Œ ê¸ˆì§€
            disableDoubleClickZoom: true,        // ë”ë¸”í´ë¦­ í™•ëŒ€ ê¸ˆì§€
            keyboardShortcuts: false             // í‚¤ë³´ë“œ ì´ë™ ê¸ˆì§€
        });


        var lat = parseFloat(facility.lat);
        var lng = parseFloat(facility.lng);

        // ì¢Œí‘œê°€ ìˆëŠ” ê²½ìš°ë§Œ ì§€ë„ ì´ë™
        if (!isNaN(lat) && !isNaN(lng)) {
            var pos = new kakao.maps.LatLng(lat, lng);

            var marker = new kakao.maps.Marker({
                map: map,
                position: pos
            });

            // ì¸í¬ìœˆë„ìš°
            var infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:14px;">${facility.name}</div>`
            });

            infowindow.open(map, marker);

            map.setCenter(pos);
            map.setLevel(2);
        } else {
            console.warn("ì¢Œí‘œ ì—†ìŒ â†’ ê¸°ë³¸ ì§€ë„ ìœ„ì¹˜ë¡œ í‘œì‹œë¨.");
        }

        // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì¸ ì²´í¬
        var btnReserve = document.querySelector('.btn-reserve');
        if (btnReserve) {
            btnReserve.addEventListener('click', function(e) {
                e.preventDefault();
                
                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (ì„¸ì…˜ ì²´í¬)
                // Django í…œí”Œë¦¿ì—ì„œ ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸
                {% if not request.session.user_id %}
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: Toast í‘œì‹œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    setTimeout(function() {
                        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    }, 500);
                {% else %}
                    // ë¡œê·¸ì¸ ìƒíƒœ: ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = this.href;
                {% endif %}
            });
        }

        // ëª¨ì§‘ê¸€ê°€ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œê·¸ì¸ ì²´í¬
        var btnRecruit = document.querySelector('.btn-recruit');
        if (btnRecruit) {
            btnRecruit.addEventListener('click', function(e) {
                e.preventDefault();
                
                // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
                {% if not request.session.user_id %}
                    // ë¹„ë¡œê·¸ì¸ ìƒíƒœ: Toast í‘œì‹œ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    setTimeout(function() {
                        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    }, 500);
                {% else %}
                    // ë¡œê·¸ì¸ ìƒíƒœ: ëª¨ì§‘ê¸€ í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = this.href;
                {% endif %}
            });
        }

    });
</script>
{% endblock %}