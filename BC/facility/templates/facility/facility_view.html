{% extends 'common/base.html' %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'facility/css/facility_list.css' %}" />
<link rel="stylesheet" href="{% static 'facility/css/facility_detail.css' %}" />
{% endblock %}

{% block script1 %}
<!-- ì¹´ì¹´ì˜¤ ì§€ë„ JS -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey={{ KAKAO_SCRIPT_KEY }}"></script>

{{ facility|json_script:"facility-data" }}

<script>
    // Djangoì—ì„œ json_scriptë¡œ ë„˜ê¸´ ë°ì´í„° íŒŒì‹±
    const facilityData = JSON.parse(document.getElementById("facility-data").textContent);
</script>
{% endblock %}

{% block title %}
ì‹œì„¤ ìƒì„¸ë³´ê¸° - í• ë˜ë§ë˜
{% endblock %}

{% block contents %}

<div class="board-hero facility-hero">
    <h2>ì‹œì„¤ì•ˆë‚´</h2>
</div>

<div class="sub-container">
    <div class="sub-content">

        <section class="detail-top-wrapper">

            <section class="detail-image-wrap">
                {% if facility.image_url %}
                <img src="{{ facility.image_url }}" alt="{{ facility.name }}">
                {% else %}
                <img src="{% static '/media/uploads/facility/photo/default.png' %}" alt="ì‚¬ì§„ ì—†ìŒ">
                {% endif %}
            </section>

            <section class="detail-info-wrap">
                <h3>{{ facility.name }}</h3>

                <section class="detail-info-row">
                    <b>ì—…ì¢…ëª… :</b> <span>{{ facility.fcob_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì£¼ì†Œ :</b> <span>{{ facility.address }}</span>
                </section>
                {% if files %}
                <section class="detail-info-row">
                    <b>ì²¨ë¶€íŒŒì¼ :</b>
                    <span>
                        <ul class="files-list">
                            {% for file in files %}
                                <li class="file-item">
                                    <a href="{% url 'board:download' file.id %}" download>
                                        {{ file.name }}
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </span>
                </section>
                {% endif %}

                {% if facility.phone %}
                <section class="detail-info-row">
                    <b>ì „í™”ë²ˆí˜¸ :</b> <span>{{ facility.phone }}</span>
                </section>
                {% endif %}

                <section class="detail-info-row">
                    <b>ìš´ì˜ìƒíƒœ :</b> <span>{{ facility.faci_stat_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì•ˆì „ë“±ê¸‰ :</b> <span>{{ facility.schk_tot_grd_nm }}</span>
                </section>

                <section class="detail-info-row">
                    <b>ì˜ˆì•½ê°€ëŠ¥ :</b>
                    <span>
                        {% if can_reserve %}
                        ê°€ëŠ¥
                        {% else %}
                        í•´ë‹¹ ì‹œì„¤ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”
                        {% endif %}
                    </span>
                </section>

                <section class="detail-buttons">
                    {% if can_reserve %}
                    <a href="{% url 'reservation:reservation_detail' facility.id %}" class="btn-reserve">
                        ì˜ˆì•½í•˜ê¸°
                    </a>
                    {% endif %}
                    {% if can_recruit %}
                    <a href="{% url 'recruitment:recruitment_list' %}?search_type=facility&keyword={{ facility.name|urlencode }}"
                       class="btn-recruit">ëª¨ì§‘ê¸€ê°€ê¸°</a>
                    {% endif %}
                    <a href="javascript:history.back();" class="back-btn">ë¦¬ìŠ¤íŠ¸ë¡œ ëŒì•„ê°€ê¸°</a>
                </section>

            </section>
        </section>

        <section class="map">
            <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
        </section>

    </div>

    <hr>

    <!-- ëŒ“ê¸€ -->
    <section class="comment-section">
        <h3 class="section-title">ëŒ“ê¸€ ({{ comments|length }})</h3>

        <ul class="comment-list">
            {% for comment in comments %}
            <li class="comment-item {% if comment.is_deleted %}comment-deleted{% endif %}">
                <div class="comment-meta">
                    <span class="comment-writer {% if comment.is_admin %}admin-badge{% endif %}">
                        {{ comment.author }}{% if comment.is_admin %} ğŸ‘‘{% endif %}
                    </span>
                    <span class="comment-date">{{ comment.reg_date|date:"Y-m-d H:i" }}</span>
                </div>
                <p class="comment-content">{{ comment.comment|linebreaksbr }}</p>
            </li>
            {% empty %}
            <li class="comment-empty">ì•„ì§ ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>
            {% endfor %}
        </ul>
        {% if user_id %}
        <form method="post" action="{% url 'facility:facility_comment' facility_id %}" class="comment-form">
            {% csrf_token %}
            <label for="comment">ëŒ“ê¸€ ì“°ê¸°</label>
            <textarea id="comment" name="content" class="comment-textarea" rows="3" required></textarea>
            <div class="comment-btn-box">
                <button type="submit" class="btn btn-submit">ë“±ë¡</button>
            </div>
        </form>
        {% endif %}
    </section>

</div>

{% endblock %}

{% block script3 %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    const container = document.getElementById("map");
    if (!container || typeof kakao === "undefined") return;

    const map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 3,
        draggable: false,
        scrollwheel: false,
        disableDoubleClickZoom: true,
        keyboardShortcuts: false
    });

    const lat = parseFloat(facilityData.lat);
    const lng = parseFloat(facilityData.lng);

    if (isNaN(lat) || isNaN(lng)) {
        console.warn("ì¢Œí‘œ ì—†ìŒ â†’ ê¸°ë³¸ ì§€ë„ ìœ„ì¹˜");
        return;
    }

    const pos = new kakao.maps.LatLng(lat, lng);

    /* ===== marker ===== */
    const marker = new kakao.maps.Marker({
        map: map,
        position: pos
    });

    /* ===== CustomOverlay (í•­ìƒ í‘œì‹œ) ===== */
    const overlay = new kakao.maps.CustomOverlay({
        position: pos,
        content: `
          <div class="customoverlay">
            <span class="title">${facilityData.name}</span>
          </div>
        `,
        xAnchor: 0.5,
        yAnchor: 2.2,   // ğŸ”¥ ë§ˆì»¤ ì•ˆ ê°€ë¦¬ë©´ì„œ ë°”ë¡œ ìœ„
        clickable: false
    });

    overlay.setMap(map);

    map.setCenter(pos);
    map.setLevel(2);
});
</script>

{% endblock %}